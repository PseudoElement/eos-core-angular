variables:
  LAST_UPLOADED_FILE: "http://git.eos.ru/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/builds/artifacts/${CI_COMMIT_REF_NAME}/raw/${HELLO_FILE}?job=html-artifacts"
  CI_DEBUG_TRACE: "true"
  TMP_WORKSPACE: WORKSPACE_$CI_PROJECT_NAME
  SERVER_FOLDER: $TFS_TARGET_PATH
  LOCAL_FOLDER: /home/gitlab-runner/builds/ee8663fb/0/dev/nadzor/classif/dist
  BIN_FOLDER: /home/gitlab-runner/builds/ee8663fb/0/dev/nadzor/classif/dist
  


stages:
  - build
  - test
  - deploy
  - cleanup


## build stage

build_job:
  stage: build
  tags:
    - ruby
    - compass
  script:
    - 'npm install'
    - 'npm run build-prod'
  only:
    - master
  artifacts:
    expire_in: 1 week
    paths:
      - dist/

## deploy stage

publish_job:
  stage: deploy
  script:
    - 'echo CI_RUNNER_ID: $CI_RUNNER_ID'
    - 'echo CI_PIPELINE_ID: $CI_PIPELINE_ID'
    - 'echo CI_PROJECT_ID: $CI_PROJECT_ID'
    - 'echo CI_PROJECT_DIR: $CI_PROJECT_DIR'
    - 'echo CI_PROJECT_NAME: $CI_PROJECT_NAME'
    - 'echo CI_JOB_ID: $CI_JOB_ID'
    - 'echo CI_JOB_NAME: $CI_JOB_NAME'
    - 'echo luf: $LAST_UPLOADED_FILE'
    - 'echo target path: $TFS_TARGET_PATH'
    - 'echo workspace: $TMP_WORKSPACE'
    - 'echo server folder: $SERVER_FOLDER'
    - 'echo server folder: $LOCAL_FOLDER'
    
    - 'echo tf workspace -new $TMP_WORKSPACE'
    - 'echo tf workfold -map $SERVER_FOLDER $LOCAL_FOLDER -workspace:$TMP_WORKSPACE'
    - 'echo tf get $LOCAL_FOLDER -force -recursive'
    
    - 'echo rm -r -f  $LOCAL_FOLDER/*'
    - 'echo cp $BIN_FOLDER/* $LOCAL_FOLDER'
    - 'echo tf delete -detect -recursive $LOCAL_FOLDER'
    - 'echo tf add -noignore -recursive $LOCAL_FOLDER'
    - 'echo tf delete -detect -recursive $LOCAL_FOLDER'
    - 'echo tf checkin $LOCAL_FOLDER -comment:"This is test checkin from Ubuntu" -override:"Automated Build Process" -recursive'
    
    - 'echo tf workspace -delete $TMP_WORKSPACE'
    

## cleanup stage

cleanup_job:
  stage: cleanup
  script:
    - 'echo rm -r -f  $LOCAL_FOLDER'
    - 'echo tf workspace -delete $TMP_WORKSPACE'
  when: always
