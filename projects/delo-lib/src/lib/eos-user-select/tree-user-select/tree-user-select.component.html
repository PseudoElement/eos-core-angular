<div class="tree-user-select-wrapper">
    <!-- табы выбора мода -->
    <div class="select-modes">
        <ul class="tabs">
            <li class="tab-item"
                *ngFor="let tab of modes"
                role="presentation"
                [ngClass]="{'active secondary-text': tab.key === currMode}"
                (click)="setTab(tab.key)"
            >
                <span
                    containerClass="tooltip-info"
                    tooltip="{{tab.tooltip}}"
                    placement="bottom"
                    class="tab-title"
                >{{tab.title}}</span>
            </li>
        </ul>
        <div 
            #pop="bs-popover"
            class="switch-menu" 
            [popover]="contextMenu" 
            placement="bottom"
            containerClass="wrapper-context-menu"
        >
            <button
                class="btn"
                [ngClass]="{'active-btn': pop.isOpen}"
            >
                <span [ngClass]="pop.isOpen ? 'eos-adm-icon eos-adm-icon-fab-white small': 
                                              'eos-adm-icon eos-adm-icon-fab-blue small'"
                ></span>
            </button>
        </div>
    </div>

    <div *ngIf="!isLoading; else spiner" class="tree-wrapper-overflow">
        <ng-container [ngSwitch]="GetTypeUsers()">

            <ng-container *ngSwitchCase="'users'">
                <ng-container *ngTemplateOutlet="treeTmpl; context: {items: nodes, level: 0}"></ng-container>
            </ng-container>

            <ng-container *ngSwitchCase="'del'">
                <div class="eos-adm-tree-node" *ngIf="nodes[0].title === 'Все подразделения'">
                    <div [ngClass]="{'highlighted' : true, 'node': true, 'activeTree': true}"
                        [ngStyle]="{'padding-left.px': getPadding(1)}">
                        <div class="title"
                            [ngClass]="{'deleted': false, 'select': false}"
                            [style.width.px]="getNodeWidth(0)">
                            <span class="title-item">{{nodes[0].title}}</span>
                        </div>
                    </div>
                </div>
            </ng-container>

            <ng-container *ngSwitchCase="'tech'">
                <div *ngIf="nodes[0].title === 'Все подразделения'; else centCard">
                    <div class="eos-adm-tree-node">
                        <div [ngClass]="{'highlighted' : true, 'node': true, 'activeTree': true}"
                        [ngStyle]="{'padding-left.px': getPadding(1)}">
                            <div class="title"
                                [ngClass]="{'deleted': false, 'select': false}"
                                [style.width.px]="getNodeWidth(0)">
                                <span class="title-item">{{nodes[0].title}}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <ng-template #centCard>
                    <ng-container *ngTemplateOutlet="treeTmpl; context: {items: nodes, level: 0}"></ng-container>
                </ng-template>
            </ng-container>

        </ng-container>

    </div>
</div>

<ng-template #treeTmpl
    let-items="items"
    let-level="level">
    <div *ngFor="let node of items"
        class="eos-adm-tree-node">
        <ng-container *ngTemplateOutlet="treeNodeTmpl; context:{node: node, level:level}"></ng-container>
    </div>
</ng-template>

<ng-template #treeNodeTmpl
    let-node="node"
    let-level="level">
    <ng-container *ngIf="node && (!node.isDeleted || showLogicallyDeleted)">
        <div
            #el
            (click)="onSelect($event, node)"
            [ngClass]="{'highlighted' : node.isActive, 'node': true, 'activeTree': node.id === id}"
            [ngStyle]="{'padding-left.px': getPadding(level)}">
            <!-- span class="fake-padding"></span -->
            <div class="tree-btn"
                (click)="onExpand($event, node)">
                <span *ngIf="node.expandable"
                    class="eos-adm-icon tringle-size icon"
                    [ngClass]="{'eos-adm-icon-open-folder-blue': node.isExpanded, 'eos-adm-icon-close-folder-blue': !node.isExpanded}"></span>
            </div>
            <div class="title"
                [ngClass]="{'deleted': node.isDeleted, 'select': node.isActive}"
                [style.width.px]="getNodeWidth(level)">
                <span class="title-item">{{node.title}}</span>
                <eos-spinner *ngIf="node.updating"
                    size="sm"></eos-spinner>
            </div>
        </div>
        <ng-container *ngIf="node.isExpanded && node.expandable">
            <ng-container *ngTemplateOutlet="treeTmpl; context: {items: childrenTree(node.children, sortContextMenu), level: level*1+1}"></ng-container>
        </ng-container>
    </ng-container>
</ng-template>

<ng-template #spiner>
    <eos-spinner size="lg"></eos-spinner>
</ng-template>

<ng-template #contextMenu>
    <div class="context-menu">
        <p class="menu-item" *ngIf="!showLogicallyDeleted" (click)="togleParam('showLogicallyDeleted')">
            <span>Показать логически удаленные</span>
        </p>
        <p class="menu-item" *ngIf="showLogicallyDeleted" (click)="togleParam('showLogicallyDeleted')">
            <span>Скрыть логически удаленные</span>
        </p>
        <p class="menu-item" *ngIf="!sortContextMenu" (click)="togleParam('sortContextMenu')">
            <span>Сортировать по алфавиту</span>
        </p>
        <p class="menu-item" *ngIf="sortContextMenu" (click)="togleParam('sortContextMenu')">
            <span>Сортировать по умолчанию</span>
        </p>
    </div>
</ng-template>